{% extends "base.html" %}

{% block title %}
reminders
{% endblock title %}

{% block meta_desc %}
Recordatorios
{% endblock meta_desc %}

{% block mid_nav_summary %}Recordatorios{% endblock mid_nav_summary %}

{% block content %}

{% set modal_id = "reminder_modal" %}
{% if can_schedule_reminder %}
{% include "widgets/btn_open_modal.html" %}
{% else %}
<nav style="padding: 1em;">
    <ul></ul>
    <ul><mark>ingrese un número de whatsapp en su perfil</mark></ul>
</nav>
{% endif %}
<div popover id="{{modal_id}}">
    <form method="dialog" style="padding: 2rem;" hx-post='/reminder' hx-swap="none" hx-on::after-request="this.reset(); updateRepeatUI();"
        hx-headers='js:{timezone: Intl.DateTimeFormat().resolvedOptions().timeZone}'>
        <fieldset>
            <label>
                Cuando?
                <input type="datetime-local" name="when" aria-label="Datetime local" required>
            </label>
            <label>
                Recordatorio
                <textarea name="body" placeholder="Cual seria el recordatorio"></textarea>
            </label>
            <label>
                Repetir
                <select name="repeat_type" id="repeat_type" onchange="updateRepeatUI()">
                    <option value="">Sin repetición</option>
                    <option value="daily">Diario</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensual</option>
                </select>
            </label>
            <div id="repeat_interval_container" style="display: none;">
                <label>
                    <span id="repeat_interval_label">Cada cuántos?</span>
                    <input type="number" name="repeat_interval" id="repeat_interval"
                           min="1" max="365" value="1" oninput="updateRepeatUI()">
                </label>
                <small id="repeat_max_hint" style="color: #666;"></small>
            </div>
            <div id="repeat_summary" style="font-style: italic; color: #666;"></div>
        </fieldset>

        <button style="width: 100%;"
            hx-on:click="document.getElementById('{{modal_id}}').hidePopover()">Guardar</button>
    </form>
</div>
<script>
// Max intervals based on AWS Step Functions 1-year limit
const REPEAT_LIMITS = {
    daily: { max: 365, unit: 'días', label: 'Cada cuántos días?' },
    weekly: { max: 52, unit: 'semanas', label: 'Cada cuántas semanas?' },
    monthly: { max: 12, unit: 'meses', label: 'Cada cuántos meses?' }
};

function updateRepeatUI() {
    const type = document.getElementById('repeat_type').value;
    const intervalInput = document.getElementById('repeat_interval');
    const container = document.getElementById('repeat_interval_container');
    const summary = document.getElementById('repeat_summary');
    const hint = document.getElementById('repeat_max_hint');
    const label = document.getElementById('repeat_interval_label');

    container.style.display = type ? 'block' : 'none';

    if (!type) {
        summary.textContent = '';
        hint.textContent = '';
        return;
    }

    const limit = REPEAT_LIMITS[type];
    if (limit) {
        intervalInput.max = limit.max;
        label.textContent = limit.label;
        hint.textContent = `Máximo: ${limit.max} ${limit.unit} (1 año)`;

        // Clamp value if exceeds max
        if (parseInt(intervalInput.value) > limit.max) {
            intervalInput.value = limit.max;
        }
    }

    const interval = intervalInput.value || 1;
    const summaries = {
        daily: interval == 1 ? 'Se repite diariamente' : `Se repite cada ${interval} días`,
        weekly: interval == 1 ? 'Se repite semanalmente' : `Se repite cada ${interval} semanas`,
        monthly: interval == 1 ? 'Se repite mensualmente' : `Se repite cada ${interval} meses`
    };
    summary.textContent = summaries[type] || '';
}
</script>

<table class="striped">
    <thead>
        <tr>
            <th>-</th>
            <th>Cuándo?</th>
            <th>Recordatorio</th>
        </tr>
    </thead>
    <tbody hx-get="/reminder/tbody" hx-trigger="reminderRecordUpdated from:body">
        {% include "widgets/tbody_reminder.html" %}
    </tbody>
</table>

{% endblock content %}