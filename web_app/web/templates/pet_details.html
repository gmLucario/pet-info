{% extends "base.html" %}

{% block title %}
pet details
{% endblock title %}

{% block meta_desc %}
datos de tu mascota
{% endblock meta_desc %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/quill.snow.css" />
<link rel="stylesheet" href="/static/css/cropper.min.css" />
<style>
    .cropper-view-box {
        border-radius: 50%;
        box-shadow: 0 0 0 1px #39f;
        outline: 0;
    }

    .cropper-face {
        border-radius: 50%;
    }

    .img-container.image-loaded {
        height: 50vh;
    }
</style>
{% endblock extra_css %}

{% block mid_nav_content %}
{% endblock mid_nav_content %}

{% block content %}
{% include "widgets/add_pet_form.html" %}
{% endblock content %}

{% block extra_js %}
<script src="/static/js/cropper.min.js"></script>
<script src="/static/js/quill.js"></script>
<script src="/static/js/heic2any.min.js"></script>
<script>
    let cropper;
    let normalizedImageBlob = null;

    const initCropper = (imageSrc) => {
        const preview = document.getElementById('pet-pic-preview');
        preview.src = imageSrc;

        preview.onload = function () {
            document.querySelector('.img-container').classList.add('image-loaded');
            if (cropper) {
                cropper.destroy();
            }

            cropper = new Cropper(preview, {
                aspectRatio: 1,
                viewMode: 1,
                guides: true,
                autoCropArea: 0.8,
                responsive: true,
                restore: false
            });
        }
    };

    const normalizeImage = (file) => {
        return new Promise((resolve, reject) => {
            const isHeic = file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic';

            if (isHeic) {
                heic2any({
                    blob: file,
                    toType: "image/jpeg",
                })
                    .then(resolve)
                    .catch(reject);
            } else {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob((blob) => {
                        if (blob) resolve(blob);
                        else reject(new Error("Canvas toBlob failed"));
                    }, 'image/jpeg', 0.95);
                };
                img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    reject(e);
                };
                img.src = url;
            }
        });
    };

    const previewPhoto = () => {
        normalizedImageBlob = null;
        const file = input.files[0];
        if (!file) return;

        normalizeImage(file)
            .then((blob) => {
                normalizedImageBlob = blob;
                const url = URL.createObjectURL(blob);
                initCropper(url);
            })
            .catch((e) => {
                console.error("Image normalization failed", e);
            });
    }

    const input = document.getElementById('pet-pic-input');
    input.addEventListener("change", previewPhoto);

    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline', 'blockquote'],
                [{ 'list': 'bullet' }],
                [{ 'indent': '-1' }, { 'indent': '+1' }],
            ]
        }
    });
    const form = document.querySelector('form');
    {% if pet %}
    quill.root.innerHTML = '{{pet.about_pet | safe}}';
    {% endif %}

    form.addEventListener('formdata', (event) => {
        event.formData.append('about_pet', quill.root.innerHTML);

        if (normalizedImageBlob) {
            event.formData.set('pet_pic', normalizedImageBlob, 'image.jpg');
        }

        if (cropper) {
            const cropData = cropper.getData();

            event.formData.append('cropper_box', JSON.stringify({
                "x": Math.round(cropData.x + (cropData.width / 2)),
                "y": Math.round(cropData.y + (cropData.height / 2)),
                "diameter": Math.round(cropData.width),
            }));
        }
    });
</script>
{% endblock extra_js %}